name: DevSecOps CI/CD Pipeline

# K√≠ch ho·∫°t khi c√≥ code push v√†o nh√°nh main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- JOB 1: SECURITY & INTEGRATION TEST (CI) ---
  security-and-build:
    runs-on: ubuntu-latest

    steps:
    # 1. L·∫•y code v·ªÅ m√°y ·∫£o GitHub
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. C√†i ƒë·∫∑t Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. C√†i ƒë·∫∑t Tool (Fix: C√†i git-secrets v√†o /tmp ƒë·ªÉ tr√°nh qu√©t nh·∫ßm)
    - name: Install Security Tools
      run: |
        echo "Installing Bandit..."
        pip install bandit

        echo "Installing git-secrets..."
        git clone https://github.com/awslabs/git-secrets.git /tmp/git-secrets
        cd /tmp/git-secrets && sudo make install
        git secrets --register-aws --global

        echo "Installing Hadolint..."
        wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
        chmod +x hadolint
        sudo mv hadolint /usr/local/bin/

    # 4. Qu√©t l·ªô Secret
    - name: Security Gate - Secret Scanning
      run: |
        echo "Running git-secrets..."
        # Qu√©t code hi·ªán t·∫°i (lo·∫°i tr·ª´ .git)
        git secrets --scan -r .

    # 5. Qu√©t m√£ ƒë·ªôc Python
    - name: Security Gate - SAST (Bandit)
      run: |
        echo "Running Bandit..."
        # B·ªè qua l·ªói B104 (bind 0.0.0.0) v√¨ ch·∫°y trong Docker
        bandit -r services/ -ll -s B104 -x tests/,venv/

    # 6. Qu√©t Dockerfile
    - name: Security Gate - Dockerfile Linting
      run: |
        echo "Running Hadolint..."
        find services -name "Dockerfile" -print0 | xargs -0 -I {} hadolint --ignore DL3008 {}

    # 7. Test Build Golden Image (Quan tr·ªçng)
    - name: Test Build Golden Image
      run: |
        echo "Building Python Golden Image..."
        docker build -t my-mini-cloud/python-golden:v1 ./infrastructure/base-images/python-golden

    # 8. Test Docker Compose Config
    - name: Integration Test - Docker Config
      run: |
        echo "Creating dummy .env for testing..."
        echo "DB_HOST=test" > infrastructure/.env
        echo "DB_NAME=test" >> infrastructure/.env
        echo "DB_USER=test" >> infrastructure/.env
        echo "DB_PASS=test" >> infrastructure/.env
        echo "JWT_SECRET_KEY=test" >> infrastructure/.env
        echo "MINIO_ROOT_USER=test" >> infrastructure/.env
        echo "MINIO_ROOT_PASSWORD=test" >> infrastructure/.env

        echo "Validating Compose Config..."
        docker compose -f infrastructure/docker-compose.yml config

  # --- JOB 2: DEPLOY TO EC2 (CD) ---
  deploy:
    needs: security-and-build # Ch·ªâ ch·∫°y n·∫øu CI xanh
    if: github.ref == 'refs/heads/main' # Ch·ªâ deploy nh√°nh main
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ [1/5] Starting Deployment on EC2..."

            # V√†o th∆∞ m·ª•c d·ª± √°n
            cd ~/mini-cloud-project

            echo "üì• [2/5] Pulling latest code..."
            # Reset code c≈© ƒë·ªÉ tr√°nh xung ƒë·ªôt file local
            git reset --hard
            git pull origin main

            echo "üî® [3/5] Re-building Golden Image..."
            # Ph·∫£i build l·∫°i m√≥ng nh√† tr∆∞·ªõc
            docker build -t my-mini-cloud/python-golden:v1 ./infrastructure/base-images/python-golden

            echo "üî• [4/5] Updating Containers..."
            cd infrastructure
            # L·ªánh n√†y th√¥ng minh: Ch·ªâ container n√†o thay ƒë·ªïi code m·ªõi b·ªã restart
            docker compose up -d --build

            echo "üßπ [5/5] Cleaning up..."
            # X√≥a image c≈© cho s·∫°ch ·ªï c·ª©ng (Quan tr·ªçng v·ªõi t3.medium)
            docker system prune -f

            echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
