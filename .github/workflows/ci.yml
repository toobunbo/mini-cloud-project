name: DevSecOps CI Pipeline

# Kích hoạt khi có code push vào nhánh main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job 1: Security & Integrity Check
  security-and-build:
    runs-on: ubuntu-latest  # Máy ảo Linux có sẵn Docker

    steps:
    # 1. Lấy code về
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Cài đặt Python (Để chạy Bandit)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Cài đặt Công cụ Bảo mật (Bandit, Git-secrets, Hadolint)
    - name: Install Security Tools
      run: |
        echo "Installing Bandit..."
        pip install bandit

        echo "Installing git-secrets..."
        git clone https://github.com/awslabs/git-secrets.git
        cd git-secrets && sudo make install && cd ..
        git secrets --register-aws --global

        echo "Installing Hadolint..."
        wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
        chmod +x hadolint
        sudo mv hadolint /usr/local/bin/

    # 4. GATE 1: Quét lộ mật khẩu/Key (Secret Scanning)
    - name: Security Gate - Secret Scanning
      run: |
        echo "Running git-secrets..."
        # Quét toàn bộ file trong thư mục hiện tại
        git secrets --scan -r .

    # 5. GATE 2: Quét mã độc Python (SAST)
    - name: Security Gate - SAST (Bandit)
      run: |
        echo "Running Bandit..."
        # Quét folder services, bỏ qua lỗi B104 (bind 0.0.0.0)
        bandit -r services/ -ll -s B104 -x tests/,venv/

    # 6. GATE 3: Quét Dockerfile (Container Security)
    - name: Security Gate - Dockerfile Linting
      run: |
        echo "Running Hadolint..."
        # Tìm tất cả Dockerfile và quét (Bỏ qua lỗi DL3008 về version apt)
        find services -name "Dockerfile" -print0 | xargs -0 -I {} hadolint --ignore DL3008 {}

    # 7. INTEGRATION TEST: Thử dựng hệ thống (Build Test)
    # Bước này thay thế cho việc AWS CodeBuild bị khóa Docker
    # GitHub Actions cho phép chạy Docker thoải mái!
    - name: Integration Test - Docker Build
      run: |
        echo "Creating dummy .env for testing..."
        # Tạo file .env giả để docker compose không lỗi thiếu biến
        echo "DB_HOST=test" > infrastructure/.env
        echo "DB_NAME=test" >> infrastructure/.env
        echo "DB_USER=test" >> infrastructure/.env
        echo "DB_PASS=test" >> infrastructure/.env
        echo "JWT_SECRET_KEY=test" >> infrastructure/.env
        echo "MINIO_ROOT_USER=test" >> infrastructure/.env
        echo "MINIO_ROOT_PASSWORD=test" >> infrastructure/.env

        echo "Building Images..."
        # Thử build để đảm bảo Dockerfile không lỗi
        docker compose -f infrastructure/docker-compose.yml build

    # 8. (Tùy chọn) Thử chạy lên xem có sập không (Smoke Test)
    - name: Integration Test - Dry Run Up
      run: |
        docker compose -f infrastructure/docker-compose.yml up -d
        sleep 10
        docker compose -f infrastructure/docker-compose.yml ps
        # Kiểm tra xem có container nào bị Exit không
        if [ $(docker compose -f infrastructure/docker-compose.yml ps -q | xargs docker inspect -f '{{.State.ExitCode}}' | grep -v 0 | wc -l) -gt 0 ]; then
          echo "Error: Some containers failed to start!"
          exit 1
        fi
        echo "All containers started successfully in test environment!"
